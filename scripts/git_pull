#!/bin/bash

BINDIR=$(cd $(dirname $0) && pwd)

. ${BINDIR}/common
. ${BINDIR}/functions

teeOutput

if curl --silent --head https://github.com | grep "Content-Type: text/html; charset=utf-8" >/dev/null; then
	GITBRANCH=$(cd ${FPPDIR} && git branch | grep "^\*" | sed -e "s/\*\s//")

	echo "Upgrading git revision from branch ${GITBRANCH}"

	MOUNTSTATE=$(mount | grep "on / type" | cut -f2 -d\( | cut -f1 -d,)

	if [ "x${MOUNTSTATE}" = "xro" ]
	then
		echo "Remounting root filesystem Read-Write"
		sudo mount -o remount,rw /
	fi

	if [ "x${FPPDIR}" = "x/opt/fpp" ]
	then
		cd ${FPPDIR} && $SUDO git pull && $SUDO git fetch --tags && $SUDO git submodule sync && $SUDO git submodule update --init
	else
		cd ${FPPDIR} && sudo -u ${FPPUSER} git pull && sudo -u ${FPPUSER} git fetch --tags && sudo -u ${FPPUSER} git submodule sync && sudo -u ${FPPUSER} git submodule update --init
	fi

	RELEASEBRANCH=$(echo ${GITBRANCH} | egrep "v[0-9]+\.[0-9]+")
	if [ -z "${RELEASEBRANCH}" ] || [ "x${FPPPLATFORM}" == "xLinux" ]
	then
		sudo ${SCRIPTDIR}/upgrade_config

		compileBinaries
	fi

	if [ "x${MOUNTSTATE}" = "xro" ]
	then
		echo "Remounting root filesystem Read-Only"
		sudo mount -o remount,ro /
	fi
else
	echo "Can not access github, unable to pull git updates"
fi

